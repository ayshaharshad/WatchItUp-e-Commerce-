{% extends 'products/base.html' %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock %}

{% block content %}
<!-- Breadcrumbs -->
<div class="breadcrumbs">
    <div class="container">
        <div class="row">
            <div class="col">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'products:home' %}">Home</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'products:product_list' %}">Products</a></li>
                        {% if breadcrumb_category %}
                        <li class="breadcrumb-item"><a href="{% url 'products:product_list' %}?category={{ breadcrumb_category }}">{{ breadcrumb_category }}</a></li>
                        {% endif %}
                        <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
</div>

<div class="colorlib-product">
    <div class="container">
        <div class="row row-pb-lg product-detail-wrap">
            <!-- ========================================== -->
            <!-- IMAGE CAROUSEL SECTION -->
            <!-- ========================================== -->
            <div class="col-sm-8">
                <div class="product-image-carousel">
                    {% if all_images %}
                    <div class="main-image-container">
                        <div class="image-wrapper">
                            <img src="{{ all_images.0.url|default:'/static/products/images/no-image.jpg' }}" 
                                 alt="{{ product.name }}" 
                                 class="main-image" 
                                 id="main-image"
                                 data-zoom="{{ all_images.0.zoom_image|default:all_images.0.url }}">
                            
                            <div class="image-indicator" id="image-indicator">
                                {{ all_images.0.variant_name|default:"Product Overview" }}
                            </div>
                            
                            <button class="nav-arrow prev" id="prev-btn" aria-label="Previous Image">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="nav-arrow next" id="next-btn" aria-label="Next Image">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            
                            <div class="image-counter">
                                <span id="current-num">1</span> / <span id="total-num">{{ all_images|length }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="thumbnail-strip">
                        <div class="thumbnails" id="thumbnails">
                            {% for image in all_images %}
                            <div class="thumbnail {% if forloop.first %}active{% endif %}" 
                                 data-index="{{ forloop.counter0 }}"
                                 data-type="{{ image.type }}"
                                 data-variant-color="{{ image.variant_color|default:'' }}"
                                 role="button" tabindex="0">
                                <img src="{{ image.url|default:'/static/products/images/no-image.jpg' }}" 
                                     alt="{{ product.name }}">
                                <div class="thumb-label">
                                    {% if image.type == 'general' %}
                                        <span class="general-label">Overview</span>
                                    {% else %}
                                        <span class="variant-label" style="background-color: {{ image.color_hex }};">
                                            {{ image.variant_name }}
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <div class="no-images">
                        <img src="{% static 'products/images/no-image.jpg' %}" 
                             alt="No Image Available" 
                             class="img-fluid">
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- ========================================== -->
            <!-- PRODUCT INFORMATION SECTION -->
            <!-- ========================================== -->
            <div class="col-sm-4">
                <div class="product-detail-desc">
                    <!-- ✅ GENERAL PRODUCT INFO -->
                    <h3>{{ product.name }}</h3>
                    {% if product.brand %}
                        <p class="brand-name">Brand: <strong>{{ product.brand.name }}</strong></p>
                    {% endif %}
                    <p class="category-name">Category: <strong>{{ product.category.name }}</strong></p>

                    <!-- Ratings -->
                    {% if product.average_rating > 0 %}
                    <div class="product-rating mb-3">
                        <div class="rating-stars">
                            {% for i in "12345" %}
                                {% if forloop.counter <= product.average_rating %}
                                    <i class="fas fa-star text-warning"></i>
                                {% elif forloop.counter <= product.average_rating|add:1 and product.average_rating|floatformat:0 != product.average_rating %}
                                    <i class="fas fa-star-half-alt text-warning"></i>
                                {% else %}
                                    <i class="far fa-star text-warning"></i>
                                {% endif %}
                            {% endfor %}
                            <span class="rating-text ms-2">{{ product.average_rating }}/5 ({{ product.review_count }} reviews)</span>
                        </div>
                    </div>
                    {% else %}
                    <div class="product-rating mb-3">
                        <span class="text-muted">No ratings yet</span>
                    </div>
                    {% endif %}

                    <!-- Description -->
                    {% if product.description %}
                    <div class="description mb-4">
                        <h6>Description</h6>
                        <p>{{ product.description|linebreaks }}</p>
                    </div>
                    {% endif %}

                    <!-- ========================================== -->
                    <!-- ✅ VARIANT SELECTION (Colors Only) -->
                    <!-- ========================================== -->
                    {% if has_variants %}
                    <div class="variant-selection mb-4">
                        <h6>Available Colors:</h6>
                        <p class="text-muted small">Select a color to view price, stock, and details</p>
                        <div class="color-options">
                            {% for option in variant_options %}
                            <div class="color-option" 
                                 data-variant-color="{{ option.color }}"
                                 data-is-available="{{ option.is_in_stock|yesno:'true,false' }}"
                                 {% if not option.is_in_stock %}disabled{% endif %}
                                 title="{{ option.color_display }}{% if not option.is_in_stock %} - Out of Stock{% endif %}"
                                 role="button" tabindex="0">
                                <div class="color-swatch" style="background-color: {{ option.color_hex }};"></div>
                                <span>{{ option.color_display }}</span>
                                {% if not option.is_in_stock %}
                                    <span class="text-danger small">(Out of Stock)</span>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- ========================================== -->
                    <!-- ✅ VARIANT DETAILS (Shows ONLY after selection) -->
                    <!-- ========================================== -->
                    <div id="variant-details" style="display: none;">
                        <div class="variant-info-card">
                            <!-- Price Section -->
                            <div class="price-section mb-3" id="price-display">
                                <!-- Will be populated by JavaScript -->
                            </div>
                            
                            <!-- Stock Section -->
                            <div class="stock-info mb-3" id="stock-display">
                                <!-- Will be populated by JavaScript -->
                            </div>
                            
                            <!-- SKU Section -->
                            <div class="sku-display mb-3">
                                <strong>SKU:</strong> 
                                <span id="display-sku">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- ========================================== -->
                    <!-- NO VARIANT PRODUCTS (Show basic info) -->
                    <!-- ========================================== -->
                    {% if not has_variants %}
                    <div class="no-variant-info">
                        <div class="price-section mb-3">
                            {% if best_offer %}
                                {% with offer_price=best_offer.get_discounted_price|floatformat:2 %}
                                <span class="current-price text-success">₹{{ offer_price }}</span>
                                <span class="original-price">₹{{ product.base_price }}</span>
                                <span class="discount-badge">{{ best_offer.discount_percentage|floatformat:0 }}% OFF</span>
                                {% endwith %}
                            {% else %}
                                <span class="current-price">₹{{ product.base_price }}</span>
                            {% endif %}
                        </div>
                        
                        <div class="stock-info mb-3">
                            {% if product.stock > 0 %}
                                <span class="stock-available">
                                    <i class="fas fa-check-circle"></i>
                                    In Stock - {{ product.stock }} available
                                </span>
                            {% else %}
                                <span class="stock-out">
                                    <i class="fas fa-times-circle"></i>
                                    Out of Stock
                                </span>
                            {% endif %}
                        </div>
                        
                        <div class="sku-display mb-3">
                            <strong>SKU:</strong> WU-{{ product.id|stringformat:"04d" }}
                        </div>
                    </div>
                    {% endif %}

                    <!-- ========================================== -->
                    <!-- ACTION BUTTONS -->
                    <!-- ========================================== -->
                    <div class="product-actions mt-4">
                        <form method="post" action="{% url 'products:add_to_cart' uuid=product.uuid %}" id="cart-form">
                            {% csrf_token %}
                            <input type="hidden" name="variant_color" id="selected-variant" value="">
                            <input type="hidden" name="quantity" value="1">
                            
                            <div class="action-buttons">
                                <button type="submit" class="btn btn-primary btn-lg btn-add-cart" id="add-to-cart-btn" 
                                        {% if has_variants %}disabled{% endif %}>
                                    <i class="icon-shopping-cart"></i> 
                                    {% if has_variants %}Select Color First{% else %}Add to Cart{% endif %}
                                </button>
                                
                                {% if user.is_authenticated %}
                                    <button type="button" 
                                            class="btn btn-outline-secondary btn-lg btn-wishlist" 
                                            id="wishlist-btn"
                                            data-product-uuid="{{ product.uuid }}"
                                            {% if has_variants %}disabled{% endif %}>
                                        <i class="icon-heart" id="wishlist-icon"></i>
                                        <span id="wishlist-text">Wishlist</span>
                                    </button>
                                {% else %}
                                    <a href="{% url 'users:login' %}?next={{ request.path }}" 
                                       class="btn btn-outline-secondary btn-lg">
                                        <i class="icon-heart"></i> Login to Save
                                    </a>
                                {% endif %}
                            </div>
                            
                            <div class="cart-note">
                                <small id="cart-note-text">
                                    {% if has_variants %}
                                        Please select a color to continue
                                    {% else %}
                                        Ready to add to cart
                                    {% endif %}
                                </small>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- STYLES -->
<!-- ========================================== -->
<style>
/* Image Carousel */
.product-image-carousel { position: relative; }
.main-image-container { background: #f8f9fa; border-radius: 12px; overflow: hidden; margin-bottom: 20px; position: relative; }
.image-wrapper { position: relative; min-height: 400px; display: flex; align-items: center; justify-content: center; }
.main-image { width: 100%; max-height: 600px; object-fit: contain; cursor: pointer; display: block; transition: transform 0.3s ease; }
.image-indicator { position: absolute; top: 15px; left: 15px; background: rgba(0, 0, 0, 0.8); color: white; padding: 8px 15px; border-radius: 20px; font-size: 13px; font-weight: 500; z-index: 5; }
.nav-arrow { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255, 255, 255, 0.9); border: none; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); z-index: 5; }
.nav-arrow:hover { background: #88c8bc; color: white; }
.nav-arrow.prev { left: 15px; }
.nav-arrow.next { right: 15px; }
.image-counter { position: absolute; bottom: 15px; right: 15px; background: rgba(0, 0, 0, 0.7); color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; z-index: 5; }

/* Thumbnails */
.thumbnail-strip { padding: 10px 0; }
.thumbnails { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; }
.thumbnail { flex: 0 0 80px; height: 80px; border-radius: 8px; overflow: hidden; cursor: pointer; border: 2px solid transparent; position: relative; transition: all 0.3s ease; }
.thumbnail:hover { border-color: #88c8bc; transform: translateY(-2px); }
.thumbnail.active { border-color: #88c8bc; box-shadow: 0 0 0 2px rgba(136, 200, 188, 0.3); }
.thumbnail img { width: 100%; height: 100%; object-fit: cover; }
.thumb-label { position: absolute; bottom: 0; left: 0; right: 0; padding: 2px 4px; font-size: 9px; text-align: center; font-weight: 600; }
.general-label { background: rgba(0, 0, 0, 0.8); color: white; }
.variant-label { color: white; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5); }

/* ✅ Color Selection - No Details Yet */
.color-options { display: flex; flex-wrap: wrap; gap: 8px; }
.color-option { display: flex; align-items: center; gap: 6px; padding: 8px 12px; border: 2px solid #ddd; border-radius: 20px; cursor: pointer; transition: all 0.3s ease; font-size: 13px; }
.color-option:hover:not([disabled]) { border-color: #88c8bc; background: #f0f9f8; }
.color-option.selected { border-color: #88c8bc; background: #e0f5f2; font-weight: 600; }
.color-option[disabled] { opacity: 0.5; cursor: not-allowed; }
.color-swatch { width: 16px; height: 16px; border-radius: 50%; border: 1px solid #ccc; }

/* ✅ Variant Details Card - Shows After Selection */
.variant-info-card { background: #f8f9fa; padding: 20px; border-radius: 8px; border: 2px solid #88c8bc; }

/* Price Display */
.current-price { font-size: 1.8em; font-weight: bold; color: #28a745; }
.original-price { text-decoration: line-through; color: #6c757d; font-size: 1.2em; margin-left: 10px; }
.discount-badge { background: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: 600; margin-left: 10px; }

/* Stock Status */
.stock-available { color: #28a745; font-weight: 500; }
.stock-out { color: #dc3545; font-weight: 500; }

/* Action Buttons */
.action-buttons { display: flex; gap: 12px; margin-bottom: 15px; }
.action-buttons .btn { flex: 1; padding: 12px 20px; font-weight: 600; border-radius: 8px; }
.btn-wishlist.btn-danger { background-color: #dc3545; border-color: #dc3545; color: white; }
.btn-wishlist.btn-danger:hover { background-color: #c82333; border-color: #bd2130; }
.cart-note { text-align: center; padding: 8px 12px; background: #e3f2fd; border-radius: 6px; }

@media (max-width: 768px) {
    .nav-arrow { width: 35px; height: 35px; }
    .action-buttons { flex-direction: column; }
    .thumbnail { flex: 0 0 60px; height: 60px; }
}
</style>

<!-- ========================================== -->
<!-- JAVASCRIPT -->
<!-- ========================================== -->
<script>
$(document).ready(function() {
    let currentIndex = 0, images = [], filteredImages = [];
    const hasVariants = {{ has_variants|yesno:"true,false" }};
    const productUuid = "{{ product.uuid }}";
    let selectedVariantColor = null;
    
    // Build images array
    {% for image in all_images %}
    images.push({
        url: "{{ image.url|escapejs }}",
        zoom: "{{ image.zoom_image|escapejs }}",
        type: "{{ image.type }}",
        variantColor: "{{ image.variant_color|escapejs }}",
        variantName: "{{ image.variant_name|escapejs }}"
    });
    {% endfor %}
    
    // Initialize - show only general images
    function initializeImages() {
        filteredImages = images.filter(img => img.type === 'general');
        if (filteredImages.length === 0) filteredImages = images;
        currentIndex = 0;
        updateDisplay();
        updateThumbnails();
    }
    
    function filterToVariant(variantColor) {
        selectedVariantColor = variantColor;
        filteredImages = images.filter(img => 
            img.type === 'variant' && img.variantColor === variantColor
        );
        if (filteredImages.length === 0) {
            filteredImages = images.filter(img => img.type === 'general');
        }
        currentIndex = 0;
        updateDisplay();
        updateThumbnails();
    }
    
    function updateDisplay() {
        if (!filteredImages.length) return;
        const current = filteredImages[currentIndex];
        $('#main-image').attr('src', current.url).attr('data-zoom', current.zoom);
        $('#image-indicator').text(current.variantName);
        $('#current-num').text(currentIndex + 1);
        $('#total-num').text(filteredImages.length);
    }
    
    function updateThumbnails() {
        const $thumbnails = $('#thumbnails');
        $thumbnails.empty();
        filteredImages.forEach((img, idx) => {
            const isActive = idx === currentIndex ? 'active' : '';
            const labelClass = img.type === 'general' ? 'general-label' : 'variant-label';
            const labelText = img.type === 'general' ? 'Overview' : img.variantName;
            const $thumb = $(`<div class="thumbnail ${isActive}" data-index="${idx}"><img src="${img.url}" alt="${img.variantName}"><div class="thumb-label"><span class="${labelClass}">${labelText}</span></div></div>`);
            $thumb.on('click', function() {
                currentIndex = idx;
                updateDisplay();
                $('.thumbnail').removeClass('active');
                $(this).addClass('active');
            });
            $thumbnails.append($thumb);
        });
    }
    
    $('#prev-btn').on('click', () => { currentIndex = currentIndex > 0 ? currentIndex - 1 : filteredImages.length - 1; updateDisplay(); updateThumbnails(); });
    $('#next-btn').on('click', () => { currentIndex = (currentIndex + 1) % filteredImages.length; updateDisplay(); updateThumbnails(); });
    
    // ✅ VARIANT SELECTION - Fetch and Display Details
    $('.color-option').on('click', function() {
        if ($(this).attr('disabled')) return;
        
        const variantColor = $(this).data('variant-color');
        
        $('.color-option').removeClass('selected');
        $(this).addClass('selected');
        $('#selected-variant').val(variantColor);
        
        filterToVariant(variantColor);
        
        // ✅ FETCH VARIANT DATA FROM SERVER
        $.ajax({
            url: `/products/api/variant/${productUuid}/${variantColor}/`,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    const v = response.variant;
                    
                    // Show variant details section
                    $('#variant-details').slideDown(300);
                    
                    // Update Price
                    let priceHtml = '';
                    if (v.has_offer && v.offer_price) {
                        const discount = Math.round((1 - v.offer_price / v.price) * 100);
                        priceHtml = `<span class="current-price text-success">₹${parseFloat(v.offer_price).toFixed(2)}</span>
                                    <span class="original-price">₹${parseFloat(v.price).toFixed(2)}</span>
                                    <span class="discount-badge">${discount}% OFF</span>`;
                    } else {
                        priceHtml = `<span class="current-price">₹${parseFloat(v.price).toFixed(2)}</span>`;
                    }
                    $('#price-display').html(priceHtml);
                    
                    // Update Stock
                    if (v.is_in_stock) {
                        $('#stock-display').html(`<span class="stock-available"><i class="fas fa-check-circle"></i> In Stock - ${v.stock_quantity} available</span>`);
                        $('#add-to-cart-btn').prop('disabled', false).html('<i class="icon-shopping-cart"></i> Add to Cart');
                        $('#wishlist-btn').prop('disabled', false);
                    } else {
                        $('#stock-display').html(`<span class="stock-out"><i class="fas fa-times-circle"></i> Out of Stock</span>`);
                        $('#add-to-cart-btn').prop('disabled', true).html('<i class="icon-ban"></i> Out of Stock');
                        $('#wishlist-btn').prop('disabled', true);
                    }
                    
                    // Update SKU
                    $('#display-sku').text(v.sku);
                    
                    // Update note
                    $('#cart-note-text').text(`${v.color_display} variant selected`);
                    
                    checkWishlistStatus();
                } else {
                    showMessage('Failed to load variant details', 'error');
                }
            },
            error: () => showMessage('Failed to load variant details', 'error')
        });
    });
    
    // Add to Cart
    $('#cart-form').on('submit', function(e) {
        e.preventDefault();
        
        if (hasVariants && !$('#selected-variant').val()) {
            showMessage('Please select a color variant', 'warning');
            return false;
        }
        
        const $btn = $('#add-to-cart-btn');
        const originalText = $btn.html();
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Adding...');
        
        $.ajax({
            url: $(this).attr('action'),
            method: 'POST',
            data: $(this).serialize(),
            success: function(response) {
                if (response.success) {
                    $('#cart-count').text(response.cart_count);
                    showMessage(response.message, 'success');
                    $btn.html('<i class="fas fa-check"></i> Added!').removeClass('btn-primary').addClass('btn-success');
                    setTimeout(() => {
                        if (confirm('View cart now?')) {
                            window.location.href = '{% url "products:cart_view" %}';
                        } else {
                            $btn.prop('disabled', false).html(originalText).removeClass('btn-success').addClass('btn-primary');
                        }
                    }, 1000);
                } else {
                    showMessage(response.message, 'error');
                    $btn.prop('disabled', false).html(originalText);
                }
            },
            error: () => { showMessage('Failed to add to cart', 'error'); $btn.prop('disabled', false).html(originalText); }
        });
        
        return false;
    });
    
    // Wishlist
    function checkWishlistStatus() {
        const selectedVariantColor = $('#selected-variant').val();
        $.ajax({
            url: `/products/wishlist/check/${productUuid}/`,
            method: 'GET',
            data: { 'variant_color': selectedVariantColor },
            success: function(response) {
                const $btn = $('#wishlist-btn');
                if (response.in_wishlist) {
                    $btn.removeClass('btn-outline-secondary').addClass('btn-danger');
                    $('#wishlist-text').text('In Wishlist');
                } else {
                    $btn.removeClass('btn-danger').addClass('btn-outline-secondary');
                    $('#wishlist-text').text('Wishlist');
                }
                if ($('#wishlist-count').length && response.wishlist_count) {
                    $('#wishlist-count').text(response.wishlist_count);
                }
            }
        });
    }
    
    $('#wishlist-btn').on('click', function(e) {
        e.preventDefault();
        const $btn = $(this);
        const selectedVariantColor = $('#selected-variant').val();
        
        if (hasVariants && !selectedVariantColor) {
            showMessage('Please select a color variant first', 'warning');
            return;
        }
        
        $btn.prop('disabled', true);
        
        $.ajax({
            url: `/products/wishlist/add/${productUuid}/`,
            method: 'POST',
            data: {
                'variant_color': selectedVariantColor,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    $btn.removeClass('btn-outline-secondary').addClass('btn-danger');
                    $('#wishlist-text').text('In Wishlist');
                    if ($('#wishlist-count').length) $('#wishlist-count').text(response.wishlist_count);
                    showMessage(response.message, 'success');
                } else {
                    showMessage(response.message, 'error');
                }
                $btn.prop('disabled', false);
            },
            error: () => { showMessage('Failed to add to wishlist', 'error'); $btn.prop('disabled', false); }
        });
    });
    
    function showMessage(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : type === 'warning' ? 'alert-warning' : 'alert-danger';
        const alertDiv = $(`<div class="alert ${alertClass} alert-dismissible fade show" style="position:fixed;top:20px;right:20px;z-index:9999;min-width:300px;">${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`);
        $('body').append(alertDiv);
        setTimeout(() => alertDiv.fadeOut(300, function() { $(this).remove(); }), 5000);
    }
    
    initializeImages();
    
    // Check wishlist for non-variant products
    {% if not has_variants %}
    checkWishlistStatus();
    {% endif %}
});
</script>
{% endblock %}




