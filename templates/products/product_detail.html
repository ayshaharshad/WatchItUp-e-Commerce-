
{% extends 'products/base.html' %}
{% load static %}

{% block extra_head %}
<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock %}

{% block content %}
<!-- Breadcrumbs -->
<div class="breadcrumbs">
    <div class="container">
        <div class="row">
            <div class="col">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'products:home' %}">Home</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'products:product_list' %}">Products</a></li>
                        {% if breadcrumb_category %}
                        <li class="breadcrumb-item"><a href="{% url 'products:product_list' %}?category={{ breadcrumb_category }}">{{ breadcrumb_category }}</a></li>
                        {% endif %}
                        <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Messages -->
{% if messages %}
<div class="container">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="colorlib-product">
    <div class="container">
        <div class="row row-pb-lg product-detail-wrap">
            <!-- Image Carousel -->
            <div class="col-sm-8">
                <div class="product-image-carousel">
                    {% if all_images %}
                    <!-- Main Image Display -->
                    <div class="main-image-container">
                        <div class="image-wrapper">
                            <img src="{{ all_images.0.url|default:'/static/products/images/no-image.jpg' }}" 
                                 alt="{{ product.name }}" 
                                 class="main-image" 
                                 id="main-image">
                            
                            <!-- Enhanced Zoom Lens -->
                            <div class="zoom-lens" id="zoom-lens"></div>
                            
                            <!-- Enhanced Zoomed Image Container -->
                            <div class="zoom-result" id="zoom-result">
                                <img src="{{ all_images.0.url|default:'/static/products/images/no-image.jpg' }}" 
                                     alt="{{ product.name }}" 
                                     id="zoom-image">
                            </div>
                            
                            <!-- Image Type Indicator -->
                            <div class="image-indicator" id="image-indicator">
                                {% if all_images.0.type == 'general' %}
                                    Product Overview
                                {% else %}
                                    {{ all_images.0.variant_name }} View
                                {% endif %}
                            </div>
                            
                            <!-- Navigation Arrows -->
                            <button class="nav-arrow prev" id="prev-btn">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="nav-arrow next" id="next-btn">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            
                            <!-- Image Counter -->
                            <div class="image-counter">
                                <span id="current-num">1</span> / <span id="total-num">{{ all_images|length }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Thumbnail Strip -->
                    <div class="thumbnail-strip">
                        <div class="thumbnails" id="thumbnails">
                            {% for image in all_images %}
                            <div class="thumbnail {% if forloop.first %}active{% endif %}" 
                                 data-index="{{ forloop.counter0 }}"
                                 data-type="{{ image.type }}"
                                 data-variant-color="{{ image.variant_color|default:'' }}">
                                <img src="{{ image.url|default:'/static/products/images/no-image.jpg' }}" 
                                     alt="{{ product.name }}">
                                <div class="thumb-label">
                                    {% if image.type == 'general' %}
                                        <span class="general-label">General</span>
                                    {% else %}
                                        <span class="variant-label" style="background-color: {{ image.color_hex }};">
                                            {{ image.variant_name }}
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <!-- No Images Fallback -->
                    <div class="no-images">
                        <img src="{% static 'products/images/no-image.jpg' %}" 
                             alt="No Image Available" 
                             class="img-fluid">
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Product Information -->
            <div class="col-sm-4">
                <div class="product-detail-desc">
                    <h3>{{ product.name }}</h3>
                    {% if product.brand %}
                        <p class="brand-name">Brand: <strong>{{ product.brand.name }}</strong></p>
                    {% endif %}
                    <p class="category-name">Category: <strong>{{ product.category.name }}</strong></p>

                    <!-- Ratings -->
                    {% if product.average_rating > 0 %}
                    <div class="product-rating mb-3">
                        <div class="rating-stars">
                            {% for i in "12345" %}
                                {% if forloop.counter <= product.average_rating %}
                                    <i class="fas fa-star text-warning"></i>
                                {% elif forloop.counter <= product.average_rating|add:1 and product.average_rating|floatformat:0 != product.average_rating %}
                                    <i class="fas fa-star-half-alt text-warning"></i>
                                {% else %}
                                    <i class="far fa-star text-warning"></i>
                                {% endif %}
                            {% endfor %}
                            <span class="rating-text ms-2">{{ product.average_rating }}/5 ({{ product.review_count }} reviews)</span>
                        </div>
                    </div>
                    {% else %}
                    <div class="product-rating mb-3">
                        <span class="text-muted">No ratings yet</span>
                    </div>
                    {% endif %}

                    <!-- Dynamic Information -->
                    <div class="info-section" id="info-section">
                        <!-- General Info -->
                        <div class="info-content general-info active" id="general-info">
                            <h5><i class="fas fa-info-circle"></i> Product Overview</h5>
                            <div class="price-section">
                                <span class="price-text">{{ product.price_range }}</span>
                                {% if product.has_variants %}
                                <small class="price-note">Price varies by color</small>
                                {% endif %}
                            </div>
                            <div class="stock-info">
                                {% if product.is_in_stock %}
                                <span class="stock-available">
                                    <i class="fas fa-check-circle"></i>
                                    Available in {{ variants.count }} color{% if variants.count > 1 %}s{% endif %}
                                </span>
                                {% else %}
                                <span class="stock-out">
                                    <i class="fas fa-times-circle"></i>
                                    Currently Out of Stock
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Variant Info -->
                        {% for variant in variants %}
                        <div class="info-content variant-info" id="variant-info-{{ variant.color }}">
                            <h5>
                                <i class="fas fa-palette"></i> 
                                {{ variant.get_color_display }} Variant
                                <div class="color-dot" style="background-color: {{ variant.color_hex }};"></div>
                            </h5>
                            <div class="price-section">
                                {% if variant.original_price and variant.discount_percentage > 0 %}
                                <span class="current-price">₹{{ variant.price }}</span>
                                <span class="original-price">₹{{ variant.original_price }}</span>
                                <span class="discount-badge">{{ variant.discount_percentage }}% OFF</span>
                                {% else %}
                                <span class="current-price">₹{{ variant.price }}</span>
                                {% endif %}
                            </div>
                            <div class="variant-details">
                                <p><strong>SKU:</strong> {{ variant.sku }}</p>
                                <p><strong>Stock:</strong>
                                    {% if variant.is_in_stock %}
                                        {% if variant.stock_quantity <= 5 %}
                                            <span class="stock-low">Only {{ variant.stock_quantity }} left</span>
                                        {% else %}
                                            <span class="stock-available">{{ variant.stock_quantity }} available</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="stock-out">Out of Stock</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Color Selection -->
                    {% if variants.count > 0 %}
                    <div class="color-selection mb-4">
                        <h6>Select Color:</h6>
                        <div class="color-options">
                            {% for variant in variants %}
                            <div class="color-option" 
                                 data-variant-color="{{ variant.color }}"
                                 title="{{ variant.get_color_display }} - ₹{{ variant.price }}">
                                <div class="color-swatch" style="background-color: {{ variant.color_hex }};"></div>
                                <span>{{ variant.get_color_display }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Coupons -->
                    {% if available_coupons %}
                    <div class="coupons mb-3">
                        <h6>Available Offers:</h6>
                        {% for coupon in available_coupons %}
                        <div class="coupon">
                            <code>{{ coupon.code }}</code>
                            <span>
                                {% if coupon.discount_type == 'percentage' %}
                                Get {{ coupon.discount_value }}% off
                                {% else %}
                                Get ₹{{ coupon.discount_value }} off
                                {% endif %}
                                {% if coupon.minimum_amount > 0 %}
                                (Min: ₹{{ coupon.minimum_amount }})
                                {% endif %}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Description -->
                    {% if product.description %}
                    <div class="description mb-4">
                        <h6>Description</h6>
                        <p>{{ product.description|linebreaks }}</p>
                    </div>
                    {% endif %}

                    
                    <!-- Actions -->
                    <div class="product-actions mt-4">
                        <!-- Add to Cart Form -->
                        <form method="post" action="{% url 'products:add_to_cart' product.pk %}" id="cart-form">
                            {% csrf_token %}
                            <input type="hidden" name="variant_color" id="selected-variant" value="">
                            <input type="hidden" name="quantity" value="1">
                            
                            <div class="action-buttons">
                                <button type="submit" class="btn btn-primary btn-lg btn-add-cart">
                                    <i class="icon-shopping-cart"></i> Add to Cart
                                </button>
                                
                                <!-- Wishlist Button -->
                                {% if user.is_authenticated %}
                                    <button type="button" 
                                            class="btn btn-outline-secondary btn-lg btn-wishlist" 
                                            id="wishlist-btn"
                                            data-product-id="{{ product.pk }}"
                                            data-in-wishlist="false">
                                        <i class="icon-heart" id="wishlist-icon"></i>
                                        <span id="wishlist-text">Wishlist</span>
                                    </button>
                                {% else %}
                                    <a href="{% url 'users:login' %}?next={{ request.path }}" 
                                    class="btn btn-outline-secondary btn-lg">
                                        <i class="icon-heart"></i> Login to Save
                                    </a>
                                {% endif %}
                            </div>
                            
                            <div class="cart-note">
                                <small id="cart-note-text">
                                    {% if product.has_variants %}
                                        Select a color variant to add to cart
                                    {% else %}
                                        Ready to add to cart
                                    {% endif %}
                                </small>
                            </div>
                        </form>
                    </div>

                    <!-- Meta Information -->
                    <div class="product-meta mt-4">
                        <h6>Product Information</h6>
                        <div class="meta-grid">
                            <div class="meta-item">
                                <strong>SKU:</strong> <span id="meta-sku">WU-{{ product.id|stringformat:"04d" }}</span>
                            </div>
                            <div class="meta-item">
                                <strong>Category:</strong> {{ product.category.name }}
                            </div>
                            {% if product.brand %}
                            <div class="meta-item">
                                <strong>Brand:</strong> {{ product.brand.name }}
                            </div>
                            {% endif %}
                            <div class="meta-item">
                                <strong>Available Colors:</strong> 
                                {% if product.has_variants %}{{ variants.count }} options{% else %}Standard{% endif %}
                            </div>
                            <div class="meta-item">
                                <strong>Added:</strong> {{ product.created_at|date:"M d, Y" }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Main Image Container */
.product-image-carousel {
    position: relative;
}

.main-image-container {
    background: #f8f9fa;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 20px;
    position: relative;
}

.image-wrapper {
    position: relative;
    min-height: 400px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.main-image {
    width: 100%;
    max-height: 600px;
    object-fit: contain;
    cursor: crosshair;
    display: block;
}

/* CSS Only Zoom Effect */
.main-image {
    transition: transform 0.3s ease;
    transform-origin: center center;
}

/* Hover Zoom Effect */
.main-image:hover {
    transform: scale(1.5);
    cursor: zoom-in;
}

/* Alternative: Click to Zoom */
.main-image.zoomed {
    transform: scale(2);
    cursor: zoom-out;
}

/* Zoom Container for Better Control */
.image-wrapper {
    overflow: hidden;
    position: relative;
}

/* Optional: Smooth pan on hover */
.image-wrapper:hover .main-image {
    animation: zoomPan 10s infinite linear;
}

@keyframes zoomPan {
    0% { transform: scale(1.5) translate(0, 0); }
    25% { transform: scale(1.5) translate(-10px, -10px); }
    50% { transform: scale(1.5) translate(10px, -10px); }
    75% { transform: scale(1.5) translate(10px, 10px); }
    100% { transform: scale(1.5) translate(0, 0); }
}

/* Lens Style Zoom (Pure CSS) */
.zoom-lens {
    position: absolute;
    width: 100px;
    height: 100px;
    border: 2px solid #007bff;
    border-radius: 50%;
    background: rgba(0, 123, 255, 0.1);
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    z-index: 10;
}

.image-wrapper:hover .zoom-lens {
    opacity: 1;
}

/* Follow mouse with CSS (limited but works) */
.image-wrapper:hover .main-image {
    transform: scale(1.8);
}

/* Alternative Zoom Styles */
.zoom-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.1);
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
}

.image-wrapper:hover .zoom-overlay {
    opacity: 1;
}

/* Zoom Result - Pure CSS version */
.zoom-result {
    position: absolute;
    top: 0;
    right: -350px;
    width: 320px;
    height: 400px;
    border: 2px solid #dee2e6;
    background: white;
    opacity: 0;
    overflow: hidden;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.15);
    z-index: 1000;
    transition: opacity 0.3s ease;
}

.image-wrapper:hover .zoom-result {
    opacity: 1;
}

.zoom-result img {
    width: 200%;
    height: 200%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

/* Image Indicator */
.image-indicator {
    position: absolute;
    top: 15px;
    left: 15px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;
    z-index: 5;
}

/* Navigation Arrows */
.nav-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    z-index: 5;
}

.nav-arrow:hover {
    background: #88c8bc;
    color: white;
    transform: translateY(-50%) scale(1.1);
}

.nav-arrow.prev {
    left: 15px;
}

.nav-arrow.next {
    right: 15px;
}

/* Image Counter */
.image-counter {
    position: absolute;
    bottom: 15px;
    right: 15px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 12px;
    z-index: 5;
}

/* Thumbnails */
.thumbnail-strip {
    padding: 10px 0;
}

.thumbnails {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    padding-bottom: 10px;
}

.thumbnail {
    flex: 0 0 80px;
    height: 80px;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    border: 2px solid transparent;
    position: relative;
    transition: all 0.3s ease;
}

.thumbnail:hover {
    border-color: #88c8bc;
    transform: translateY(-2px);
}

.thumbnail.active {
    border-color: #88c8bc;
    box-shadow: 0 0 0 2px rgba(136, 200, 188, 0.3);
}

.thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.thumb-label {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 2px 4px;
    font-size: 9px;
    text-align: center;
    font-weight: 600;
}

.general-label {
    background: rgba(0, 0, 0, 0.8);
    color: white;
}

.variant-label {
    color: white;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
}

/* Info Section */
.info-section {
    background: #f8f9fa;
    border-radius: 12px;
    margin-bottom: 20px;
    border-left: 4px solid #88c8bc;
}

.info-content {
    padding: 20px;
    display: none;
}

.info-content.active {
    display: block;
}

.info-content h5 {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 15px;
    color: #333;
}

.color-dot {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    margin-left: auto;
}

/* Price */
.price-section {
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e9ecef;
}

.current-price, .price-text {
    font-size: 1.8em;
    font-weight: bold;
    color: #28a745;
}

.original-price {
    text-decoration: line-through;
    color: #6c757d;
    font-size: 1.2em;
    margin-left: 10px;
}

.discount-badge {
    background: #dc3545;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: 600;
    margin-left: 10px;
}

.price-note {
    display: block;
    margin-top: 5px;
    font-size: 0.85em;
    color: #6c757d;
}

/* Stock Status */
.stock-available { color: #28a745; font-weight: 500; }
.stock-low { color: #ffc107; font-weight: 500; }
.stock-out { color: #dc3545; font-weight: 500; }

/* Color Selection */
.color-options {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.color-option {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 13px;
}

.color-option:hover, .color-option.selected {
    border-color: #88c8bc;
    background: #f0f9f8;
}

.color-swatch {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 1px solid #ccc;
}

/* Action Buttons */
.action-buttons {
    display: flex;
    gap: 12px;
    margin-bottom: 15px;
}

.action-buttons .btn {
    flex: 1;
    padding: 12px 20px;
    font-weight: 600;
    border-radius: 8px;
}

.cart-note {
    text-align: center;
    padding: 8px 12px;
    background: #e3f2fd;
    border-radius: 6px;
}

/* Meta Grid */
.meta-grid {
    display: grid;
    gap: 8px;
}

.meta-item {
    padding: 8px 0;
    border-bottom: 1px solid #eee;
    font-size: 14px;
}

.meta-item:last-child {
    border-bottom: none;
}

/* Responsive */
@media (max-width: 768px) {
    .zoom-result {
        display: none !important;
    }
    
    .zoom-lens {
        display: none !important;
    }
    
    .main-image {
        cursor: default !important;
    }
    
    .nav-arrow {
        width: 35px;
        height: 35px;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .thumbnail {
        flex: 0 0 60px;
        height: 60px;
    }
}

@media (min-width: 1200px) {
    .zoom-result {
        right: -380px;
        width: 350px;
        height: 450px;
    }
}

</style>

<script>
$(document).ready(function() {
    let currentIndex = 0;
    let images = [];
    
    // Initialize images array
    {% for image in all_images %}
    images.push({
        url: "{{ image.url|default:'/static/products/images/no-image.jpg'|escapejs }}",
        type: "{{ image.type|escapejs }}",
        variantColor: "{{ image.variant_color|default:''|escapejs }}",
        variantName: "{{ image.variant_name|default:''|escapejs }}"
    });
    {% endfor %}
    
    // Simple Click-to-Zoom (Optional)
    function initZoom() {
        const mainImage = $('#main-image');
        
        // Click to toggle zoom
        mainImage.on('click', function(e) {
            if (window.innerWidth <= 768) return;
            
            $(this).toggleClass('zoomed');
            
            // Optional: Center zoom on click position
            if ($(this).hasClass('zoomed')) {
                const rect = this.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;
                $(this).css('transform-origin', `${x}% ${y}%`);
            } else {
                $(this).css('transform-origin', 'center center');
            }
        });
    }
    
    // Update main display
    function updateDisplay() {
        if (images.length === 0) return;
        
        const current = images[currentIndex];
        const mainImage = $('#main-image');
        const zoomImage = $('#zoom-image');
        const indicator = $('#image-indicator');
        const currentNum = $('#current-num');
        
        // Update images
        mainImage.attr('src', current.url);
        zoomImage.attr('src', current.url);
        
        // Update indicator
        if (current.type === 'general') {
            indicator.text('Product Overview');
        } else {
            indicator.text(current.variantName + ' View');
        }
        
        // Update counter
        currentNum.text(currentIndex + 1);
        
        // Update thumbnails
        $('.thumbnail').removeClass('active');
        $(`.thumbnail[data-index="${currentIndex}"]`).addClass('active');
        
        // Scroll thumbnail into view
        scrollThumbnailIntoView(currentIndex);
        
        // Update info section
        updateInfo(current);
        
        // Reinitialize zoom after image change
        setTimeout(initZoom, 100);
    }
    
    // Scroll thumbnail into view
    function scrollThumbnailIntoView(index) {
        const thumbnails = $('.thumbnails');
        const thumbnail = $(`.thumbnail[data-index="${index}"]`);
        
        if (thumbnail.length) {
            const scrollLeft = thumbnail.offset().left - thumbnails.offset().left + thumbnails.scrollLeft() - (thumbnails.width() / 2) + (thumbnail.width() / 2);
            thumbnails.animate({ scrollLeft: scrollLeft }, 300);
        }
    }
    
    // Update info section
    function updateInfo(current) {
        $('.info-content').removeClass('active');
        
        const cartNote = $('#cart-note-text');
        const selectedVariant = $('#selected-variant');
        const metaSku = $('#meta-sku');
        
        if (current.type === 'general') {
            $('#general-info').addClass('active');
            cartNote.text('{% if product.has_variants %}Select a color variant to add to cart{% else %}Ready to add to cart{% endif %}');
            selectedVariant.val('');
            metaSku.text('WU-{{ product.id|stringformat:"04d" }}');
        } else {
            const variantInfo = $(`#variant-info-${current.variantColor}`);
            if (variantInfo.length) {
                variantInfo.addClass('active');
                cartNote.text(`${current.variantName} variant selected. Ready to add to cart.`);
                selectedVariant.val(current.variantColor);
                
                // Update SKU from variant
                const skuText = variantInfo.find('p:contains("SKU:")').text();
                const sku = skuText.split(': ')[1];
                if (sku) metaSku.text(sku);
            }
        }
        
        // Update color selection
        $('.color-option').removeClass('selected');
        if (current.variantColor) {
            $(`.color-option[data-variant-color="${current.variantColor}"]`).addClass('selected');
        }
    }
    
    // Navigation functions
    function navigatePrev() {
        currentIndex = currentIndex > 0 ? currentIndex - 1 : images.length - 1;
        updateDisplay();
    }
    
    function navigateNext() {
        currentIndex = (currentIndex + 1) % images.length;
        updateDisplay();
    }
    
    // Event Handlers
    
    // Navigation arrows
    $('#prev-btn').click(navigatePrev);
    $('#next-btn').click(navigateNext);
    
    // Thumbnail clicks
    $('.thumbnail').click(function() {
        const newIndex = parseInt($(this).data('index'));
        if (newIndex !== currentIndex) {
            currentIndex = newIndex;
            updateDisplay();
        }
    });
    
    // Color option clicks
    $('.color-option').click(function() {
        const variantColor = $(this).data('variant-color');
        
        // Find first image for this variant
        const variantIndex = images.findIndex(img => 
            img.variantColor === variantColor && img.type === 'variant'
        );
        
        if (variantIndex !== -1) {
            currentIndex = variantIndex;
            updateDisplay();
        } else {
            // If no variant image found, just update info
            $('.info-content').removeClass('active');
            const variantInfo = $(`#variant-info-${variantColor}`);
            if (variantInfo.length) {
                variantInfo.addClass('active');
                $('#cart-note-text').text(`Selected variant. Ready to add to cart.`);
                $('#selected-variant').val(variantColor);
            }
        }
        
        $('.color-option').removeClass('selected');
        $(this).addClass('selected');
    });
    
    // Keyboard navigation
    $(document).keydown(function(e) {
        if (e.key === 'ArrowLeft') {
            navigatePrev();
        } else if (e.key === 'ArrowRight') {
            navigateNext();
        }
    });
    
    // Touch support for mobile swipe
    let touchStartX = 0;
    let touchStartY = 0;
    
    $('.main-image').on('touchstart', function(e) {
        touchStartX = e.originalEvent.touches[0].clientX;
        touchStartY = e.originalEvent.touches[0].clientY;
    });
    
    $('.main-image').on('touchend', function(e) {
        const touchEndX = e.originalEvent.changedTouches[0].clientX;
        const touchEndY = e.originalEvent.changedTouches[0].clientY;
        
        const deltaX = touchEndX - touchStartX;
        const deltaY = touchEndY - touchStartY;
        
        // Swipe detection (minimum 50px swipe)
        if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
            if (deltaX > 0) {
                navigatePrev();
            } else {
                navigateNext();
            }
        }
    });
    
    // Initialize everything
    updateDisplay();
    initZoom();
    
    // Reinitialize zoom when image loads
    $('#main-image').on('load', function() {
        setTimeout(initZoom, 50);
    });
    
    // Window resize handler
    $(window).resize(function() {
        // Reinitialize zoom on resize
        setTimeout(initZoom, 100);
    });
    
    // Preload adjacent images for smoother navigation
    function preloadImages() {
        const prevIndex = currentIndex > 0 ? currentIndex - 1 : images.length - 1;
        const nextIndex = (currentIndex + 1) % images.length;
        
        [prevIndex, nextIndex].forEach(index => {
            if (images[index]) {
                const img = new Image();
                img.src = images[index].url;
            }
        });
    }
    
    // Preload images after initial load
    setTimeout(preloadImages, 1000);
    
    // Add smooth hover effects
    $('.thumbnail').hover(
        function() {
            $(this).css('transform', 'translateY(-2px) scale(1.05)');
        },
        function() {
            if (!$(this).hasClass('active')) {
                $(this).css('transform', 'translateY(0) scale(1)');
            }
        }
    );
    
    $('.color-option').hover(
        function() {
            $(this).css('transform', 'scale(1.05)');
        },
        function() {
            if (!$(this).hasClass('selected')) {
                $(this).css('transform', 'scale(1)');
            }
        }
    );
    
    // Enhanced zoom result positioning for larger screens
    function adjustZoomPosition() {
        const zoomResult = $('#zoom-result');
        const container = $('.main-image-container');
        const containerRect = container[0].getBoundingClientRect();
        const windowWidth = $(window).width();
        
        // If there's not enough space on the right, position on the left
        if (containerRect.right + 350 > windowWidth) {
            zoomResult.css({
                right: 'auto',
                left: '-350px'
            });
        } else {
            zoomResult.css({
                left: 'auto',
                right: '-350px'
            });
        }
    }
    
    // Adjust zoom position on window resize
    $(window).resize(adjustZoomPosition);
    adjustZoomPosition();
});

// ============= WISHLIST FUNCTIONALITY =============


{% if user.is_authenticated %}
(function() {
    const wishlistBtn = $('#wishlist-btn');
    if (!wishlistBtn.length) return; // Exit if button doesn't exist
    
    const wishlistIcon = $('#wishlist-icon');
    const wishlistText = $('#wishlist-text');
    const productId = wishlistBtn.data('product-id');
    
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    const csrftoken = getCookie('csrftoken');
    
    // Check wishlist status on page load
    function checkWishlistStatus() {
        const variantColor = $('#selected-variant').val();
        
        $.ajax({
            url: `/products/wishlist/check/${productId}/`,
            method: 'GET',
            data: { variant_color: variantColor },
            success: function(response) {
                updateWishlistButton(response.in_wishlist);
                if (response.wishlist_count !== undefined) {
                    $('#wishlist-count').text(response.wishlist_count);
                }
            },
            error: function(xhr, status, error) {
                console.log('Failed to check wishlist status:', error);
            }
        });
    }
    
    // Update button appearance
    function updateWishlistButton(inWishlist) {
        wishlistBtn.data('in-wishlist', inWishlist);
        
        if (inWishlist) {
            wishlistBtn.addClass('in-wishlist');
            wishlistBtn.css({
                'background-color': '#dc3545',
                'border-color': '#dc3545',
                'color': 'white'
            });
            wishlistText.text('In Wishlist');
            wishlistIcon.css('color', 'white');
        } else {
            wishlistBtn.removeClass('in-wishlist');
            wishlistBtn.css({
                'background-color': '',
                'border-color': '',
                'color': ''
            });
            wishlistText.text('Wishlist');
            wishlistIcon.css('color', '');
        }
    }
    
    // Handle wishlist button click
    wishlistBtn.on('click', function(e) {
        e.preventDefault();
        
        const variantColor = $('#selected-variant').val();
        const inWishlist = wishlistBtn.data('in-wishlist');
        
        // FIX: Only check if product has MULTIPLE variants
        const variantCount = {{ variants.count }};
        if (variantCount > 1 && !variantColor) {
            showMessage('Please select a color variant first', 'warning');
            return;
        }
        
        if (inWishlist) {
            showMessage('This item is already in your wishlist', 'info');
            return;
        }
        
        // Add to wishlist
        $.ajax({
            url: `/products/wishlist/add/${productId}/`,
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            data: {
                variant_color: variantColor
            },
            success: function(response) {
                if (response.success) {
                    updateWishlistButton(true);
                    $('#wishlist-count').text(response.wishlist_count);
                    showMessage(response.message, 'success');
                } else {
                    showMessage(response.message, 'error');
                }
            },
            error: function(xhr, status, error) {
                console.log('Error adding to wishlist:', error);
                console.log('Response:', xhr.responseText);
                showMessage('Failed to add to wishlist. Please try again.', 'error');
            }
        });
    });
    
    // Check status on page load
    setTimeout(checkWishlistStatus, 500); // Small delay to ensure page is loaded
    
    // Re-check when variant changes
    $('.color-option').on('click', function() {
        setTimeout(checkWishlistStatus, 100);
    });
    
})();
{% endif %}

{% comment %} {% if user.is_authenticated %}
(function() {
    const wishlistBtn = $('#wishlist-btn');
    const wishlistIcon = $('#wishlist-icon');
    const wishlistText = $('#wishlist-text');
    const productId = wishlistBtn.data('product-id');
    
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    const csrftoken = getCookie('csrftoken');
    
    // Check wishlist status on page load
    function checkWishlistStatus() {
        const variantColor = $('#selected-variant').val();
        
        $.ajax({
            url: `/wishlist/check/${productId}/`,
            method: 'GET',
            data: { variant_color: variantColor },
            success: function(response) {
                updateWishlistButton(response.in_wishlist);
                if (response.wishlist_count !== undefined) {
                    $('#wishlist-count').text(response.wishlist_count);
                }
            },
            error: function() {
                console.log('Failed to check wishlist status');
            }
        });
    }
    
    // Update button appearance
    function updateWishlistButton(inWishlist) {
        wishlistBtn.data('in-wishlist', inWishlist);
        
        if (inWishlist) {
            wishlistBtn.addClass('in-wishlist');
            wishlistBtn.css({
                'background-color': '#dc3545',
                'border-color': '#dc3545',
                'color': 'white'
            });
            wishlistText.text('In Wishlist');
            wishlistIcon.css('color', 'white');
        } else {
            wishlistBtn.removeClass('in-wishlist');
            wishlistBtn.css({
                'background-color': '',
                'border-color': '',
                'color': ''
            });
            wishlistText.text('Wishlist');
            wishlistIcon.css('color', '');
        }
    }
    
    // Handle wishlist button click
    wishlistBtn.on('click', function(e) {
        e.preventDefault();
        
        const variantColor = $('#selected-variant').val();
        const inWishlist = wishlistBtn.data('in-wishlist');
        
        // Check if variant is required but not selected
        {% if product.has_variants %}
        if (!variantColor) {
            showMessage('Please select a color variant first', 'warning');
            return;
        }
        {% endif %}
        
        if (inWishlist) {
            showMessage('This item is already in your wishlist', 'info');
            return;
        }
        
        // Add to wishlist
        $.ajax({
            url: `/wishlist/add/${productId}/`,
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            data: {
                variant_color: variantColor
            },
            success: function(response) {
                if (response.success) {
                    updateWishlistButton(true);
                    $('#wishlist-count').text(response.wishlist_count);
                    showMessage(response.message, 'success');
                } else {
                    showMessage(response.message, 'error');
                }
            },
            error: function() {
                showMessage('Failed to add to wishlist. Please try again.', 'error');
            }
        });
    });
    
    // Check status on page load
    checkWishlistStatus();
    
    // Re-check when variant changes
    $('.color-option').on('click', function() {
        setTimeout(checkWishlistStatus, 100);
    });
    
})();
{% endif %} {% endcomment %}

// ============= ADD TO CART FUNCTIONALITY =============
$('#cart-form').on('submit', function(e) {
    e.preventDefault();
    
    const form = $(this);
    const submitBtn = form.find('.btn-add-cart');
    const originalText = submitBtn.html();
    const variantColor = $('#selected-variant').val();
    
    // Count number of variants
    const variantCount = {{ variants.count }};
    
    // Only validate if there are multiple variants
    if (variantCount > 1 && !variantColor) {
        showMessage('Please select a color variant first', 'warning');
        return false;
    }
    
    // Disable button and show loading
    submitBtn.prop('disabled', true).html('<i class="icon-refresh"></i> Adding...');
    
    $.ajax({
        url: form.attr('action'),
        method: 'POST',
        data: form.serialize(),
        success: function(response) {
            if (response.success) {
                // Update cart count
                $('#cart-count').text(response.cart_count);
                
                // Show success message
                showMessage(response.message, 'success');
                
                // Optional: Ask if user wants to view cart
                setTimeout(function() {
                    if (confirm('Item added to cart! View cart now?')) {
                        window.location.href = '{% url "products:cart_view" %}';
                    }
                }, 500);
            } else {
                showMessage(response.message, 'error');
            }
            
            // Reset button
            submitBtn.prop('disabled', false).html(originalText);
        },
        error: function(xhr) {
            let errorMsg = 'Failed to add to cart. Please try again.';
            
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMsg = xhr.responseJSON.message;
            }
            
            showMessage(errorMsg, 'error');
            submitBtn.prop('disabled', false).html(originalText);
        }
    });
    
    return false;
});

// ============= MESSAGE DISPLAY FUNCTION =============
function showMessage(message, type) {
    // Map type to Bootstrap alert class
    const alertTypes = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    };
    
    const alertClass = alertTypes[type] || 'alert-info';
    
    // Create alert HTML
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert" 
             style="position: fixed; top: 80px; right: 20px; z-index: 9999; min-width: 300px; max-width: 500px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            <strong>${type.charAt(0).toUpperCase() + type.slice(1)}!</strong> ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    `;
    
    // Remove any existing alerts
    $('.alert[style*="position: fixed"]').remove();
    
    // Add new alert
    $('body').append(alertHtml);
    
    // Auto-dismiss after 4 seconds
    setTimeout(function() {
        $('.alert[style*="position: fixed"]').fadeOut('slow', function() {
            $(this).remove();
        });
    }, 4000);
}

// ============= HANDLE GENERAL PRODUCTS (No Variants) =============
{% if not product.has_variants %}
// For products without variants, set a default value
$(document).ready(function() {
    // Mark as ready to add (no variant selection needed)
    $('#cart-note-text').text('Ready to add to cart');
});
{% endif %}

console.log('Cart and Wishlist functionality loaded successfully!');
</script>
{% endblock %}    